<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Lob - Test UI</title>
  <style>
    :root {
      --bg: #0a0a0a;
      --surface: #1a1a1a;
      --surface-hover: #252525;
      --border: #333;
      --text: #e5e5e5;
      --text-muted: #888;
      --accent: #3b82f6;
      --task: #3b82f6;
      --urgent: #ef4444;
      --self-service: #22c55e;
      --reminder: #a855f7;
      --venting: #f59e0b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 2rem;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 2rem;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    h1 span {
      color: var(--accent);
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .input-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .input-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .input-header h2 {
      font-size: 1rem;
      font-weight: 500;
    }

    .presets {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .preset-btn {
      background: var(--surface-hover);
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 0.375rem 0.75rem;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.15s;
    }

    .preset-btn:hover {
      background: var(--border);
      color: var(--text);
    }

    textarea {
      width: 100%;
      min-height: 120px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      padding: 1rem;
      font-size: 0.875rem;
      resize: vertical;
      font-family: inherit;
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    textarea::placeholder {
      color: var(--text-muted);
    }

    .actions {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      align-items: center;
    }

    .parse-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .parse-btn:hover {
      opacity: 0.9;
    }

    .parse-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .mode-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .mode-toggle input {
      accent-color: var(--accent);
    }

    .api-url {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .api-url input {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.5rem;
      border-radius: 6px;
      font-size: 0.75rem;
      width: 200px;
    }

    .api-url label {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .results-section {
      margin-bottom: 2rem;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .results-header h2 {
      font-size: 1rem;
      font-weight: 500;
    }

    .task-count {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .cards-grid {
      display: grid;
      gap: 1rem;
    }

    .task-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      border-left: 4px solid var(--task);
    }

    .task-card.urgent {
      border-left-color: var(--urgent);
    }

    .task-card.self_service {
      border-left-color: var(--self-service);
    }

    .task-card.reminder {
      border-left-color: var(--reminder);
    }

    .task-card.venting {
      border-left-color: var(--venting);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }

    .card-badges {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .badge {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.625rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .badge.task {
      background: rgba(59, 130, 246, 0.2);
      color: var(--task);
    }

    .badge.urgent {
      background: rgba(239, 68, 68, 0.2);
      color: var(--urgent);
    }

    .badge.self_service {
      background: rgba(34, 197, 94, 0.2);
      color: var(--self-service);
    }

    .badge.reminder {
      background: rgba(168, 85, 247, 0.2);
      color: var(--reminder);
    }

    .badge.venting {
      background: rgba(245, 158, 11, 0.2);
      color: var(--venting);
    }

    .badge.deadline {
      background: rgba(239, 68, 68, 0.1);
      color: var(--urgent);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .card-position {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .card-summary {
      font-size: 0.9375rem;
      line-height: 1.5;
      margin-bottom: 0.75rem;
    }

    .card-raw {
      background: var(--bg);
      border-radius: 6px;
      padding: 0.75rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
      font-style: italic;
    }

    .card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .card-meta-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .card-meta-label {
      opacity: 0.7;
    }

    .missing-info {
      margin-top: 0.75rem;
      padding: 0.75rem;
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.2);
      border-radius: 6px;
    }

    .missing-info-header {
      font-size: 0.75rem;
      color: var(--venting);
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .missing-info-list {
      list-style: none;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .missing-info-list li {
      padding: 0.25rem 0;
    }

    .missing-info-list li::before {
      content: "?";
      margin-right: 0.5rem;
      color: var(--venting);
    }

    .self-service-steps {
      margin-top: 0.75rem;
      padding: 0.75rem;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 6px;
    }

    .self-service-steps-header {
      font-size: 0.75rem;
      color: var(--self-service);
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .self-service-steps-content {
      font-size: 0.75rem;
      color: var(--text-muted);
      line-height: 1.6;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }

    .empty-state p {
      margin-bottom: 0.5rem;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    .loading::after {
      content: "";
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      margin-left: 0.75rem;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--urgent);
      padding: 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
    }

    .raw-json {
      margin-top: 2rem;
    }

    .raw-json-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .raw-json-header h3 {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-muted);
    }

    .toggle-json {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 0.75rem;
      cursor: pointer;
    }

    .json-content {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      font-family: 'SF Mono', Consolas, monospace;
      font-size: 0.75rem;
      overflow-x: auto;
      white-space: pre-wrap;
      color: var(--text-muted);
      display: none;
    }

    .json-content.visible {
      display: block;
    }

    footer {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.75rem;
      padding-top: 2rem;
      border-top: 1px solid var(--border);
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Task <span>Lob</span> Test UI</h1>
      <p class="subtitle">Paste a Jeff-style lob and watch it parse into discrete tasks</p>
    </header>

    <section class="input-section">
      <div class="input-header">
        <h2>Input</h2>
        <div class="presets">
          <button class="preset-btn" data-preset="jeff_1">Classic Multi-Task</button>
          <button class="preset-btn" data-preset="jeff_2">Stream of Consciousness</button>
          <button class="preset-btn" data-preset="jeff_3">Venting + Task</button>
          <button class="preset-btn" data-preset="edge_8">Urgent Emphasis</button>
          <button class="preset-btn" data-preset="edge_13">Emoji Heavy</button>
        </div>
      </div>

      <textarea id="input" placeholder="Paste or type a lob here... Try something like: 'First we need to fix the notification problem. 2nd the birthday page needs updating by Monday. Also I can't get into my Gmail.'"></textarea>

      <div class="actions">
        <button class="parse-btn" id="parseBtn">Parse Lob</button>
        <label class="mode-toggle">
          <input type="checkbox" id="mockMode" checked>
          Mock mode (no API required)
        </label>
        <div class="api-url">
          <label for="apiUrl">API:</label>
          <input type="text" id="apiUrl" value="http://localhost:3000">
        </div>
      </div>
    </section>

    <section class="results-section">
      <div class="results-header">
        <h2>Parsed Tasks</h2>
        <span class="task-count" id="taskCount"></span>
      </div>

      <div id="results">
        <div class="empty-state">
          <p>No tasks parsed yet.</p>
          <p>Enter some text above and click "Parse Lob"</p>
        </div>
      </div>

      <div class="raw-json">
        <div class="raw-json-header">
          <h3>Raw JSON Response</h3>
          <button class="toggle-json" id="toggleJson">Show</button>
        </div>
        <pre class="json-content" id="jsonContent"></pre>
      </div>
    </section>

    <footer>
      <p>Task Lob Test UI &middot; <a href="https://github.com/CBaen/task-lob">GitHub</a></p>
    </footer>
  </div>

  <script>
    // Test fixtures (loaded inline for simplicity)
    const presets = {
      jeff_1: `First thing we need to fix the notification problem. It has an error that needs to be fixed. 2nd we need to fix the birthday deliveries by monday because i forgot i have a TV spot with KUTV to promote them. I might need access to the google account too. WordPress sent a 3rd party authentication to the gmail account and its probably time sensitive.`,

      jeff_2: `ok so the website is doing that thing again where it just stops and I tried clicking the button but nothing happens and also we need to order more helium before friday oh and did you get my email about the corporate account I sent it yesterday or maybe the day before anyway the checkout page looks weird on my phone can you look at that when you get a chance`,

      jeff_3: `I'm so frustrated with this WordPress garbage it breaks every single week and I can never figure out what's wrong with it. The contact form stopped working again and customers are complaining.`,

      edge_8: `THIS IS URGENT. The payment gateway is DOWN. CUSTOMERS CANNOT PAY. Fix it NOW. This is the highest priority. Everything else can wait.`,

      edge_13: `ðŸš¨ URGENT ðŸš¨ The payment button is broken!!! ðŸ’¸ Customers can't buy anything ðŸ˜± Please fix ASAP ðŸ™ðŸ™ðŸ™`
    };

    // Mock parser for testing without API
    function mockParse(input) {
      // Simple heuristic-based parser for demo
      const tasks = [];

      // Check for venting patterns
      const ventingPatterns = [
        /i'm so (frustrated|tired|done|over)/i,
        /i can't (anymore|deal|stand)/i,
        /garbage|ridiculous|hate/i
      ];

      const isVenting = ventingPatterns.some(p => p.test(input));

      // Split on common task delimiters
      const chunks = input
        .split(/(?:first|1st|second|2nd|third|3rd|also|and also|oh and|anyway)/i)
        .map(s => s.trim())
        .filter(s => s.length > 10);

      // If no clear chunks, treat as single item
      const workingChunks = chunks.length > 0 ? chunks : [input];

      workingChunks.forEach((chunk, index) => {
        // Classify
        let classification = 'task';
        let urgency = 'normal';

        // Self-service detection
        if (/password|login|access|gmail|authentication|verification|code/i.test(chunk)) {
          classification = 'self_service';
        }

        // Reminder detection
        if (/TV spot|meeting|appointment|remind|don't forget/i.test(chunk)) {
          classification = 'reminder';
        }

        // Venting detection
        if (isVenting && index === 0 && /frustrated|can't|hate|garbage/i.test(chunk)) {
          classification = 'venting';
        }

        // Urgency detection
        if (/urgent|ASAP|now|immediately|down|broken|can't pay/i.test(chunk)) {
          urgency = 'urgent';
        }

        // Deadline detection
        const deadlineMatch = chunk.match(/by (monday|tuesday|wednesday|thursday|friday|saturday|sunday|tomorrow)/i);
        if (deadlineMatch) {
          urgency = 'deadline';
        }

        // System detection
        let system = null;
        if (/wordpress|website|page/i.test(chunk)) system = 'WordPress';
        if (/gmail|google/i.test(chunk)) system = 'Google';
        if (/checkout|payment|woocommerce/i.test(chunk)) system = 'WooCommerce';

        // Missing info
        const missingInfo = [];
        if (/error|problem|broken|not working/i.test(chunk) && chunk.length < 100) {
          missingInfo.push('What exactly is the error message?');
        }
        if (/the page|the thing/i.test(chunk)) {
          missingInfo.push('Which specific page?');
        }

        // Summary
        let summary = chunk
          .replace(/^[,.\s]+/, '')
          .replace(/[,.\s]+$/, '')
          .substring(0, 100);

        if (summary.length < chunk.length) summary += '...';

        tasks.push({
          position: index + 1,
          rawChunk: chunk,
          summary: summary,
          classification: classification,
          urgency: urgency,
          deadline: deadlineMatch ? deadlineMatch[1] : null,
          system: system,
          missingInfo: missingInfo,
          selfServiceSteps: classification === 'self_service'
            ? 'Check your email or phone for the verification code. If you can\'t find it, check spam folder.'
            : null
        });
      });

      return { tasks };
    }

    // Render task cards
    function renderCards(data) {
      const results = document.getElementById('results');
      const taskCount = document.getElementById('taskCount');

      if (!data.tasks || data.tasks.length === 0) {
        results.innerHTML = `
          <div class="empty-state">
            <p>No tasks found in this input.</p>
          </div>
        `;
        taskCount.textContent = '0 tasks';
        return;
      }

      taskCount.textContent = `${data.tasks.length} task${data.tasks.length !== 1 ? 's' : ''} found`;

      results.innerHTML = `
        <div class="cards-grid">
          ${data.tasks.map(task => renderCard(task)).join('')}
        </div>
      `;
    }

    function renderCard(task) {
      const urgencyClass = task.urgency === 'urgent' || task.urgency === 'deadline' ? 'urgent' : '';
      const typeClass = task.classification;

      const badges = [];
      badges.push(`<span class="badge ${task.classification}">${formatClassification(task.classification)}</span>`);

      if (task.urgency === 'urgent') {
        badges.push(`<span class="badge urgent">URGENT</span>`);
      }
      if (task.deadline) {
        badges.push(`<span class="badge deadline">ðŸ“… ${task.deadline}</span>`);
      }

      let extras = '';

      if (task.missingInfo && task.missingInfo.length > 0) {
        extras += `
          <div class="missing-info">
            <div class="missing-info-header">Missing Information</div>
            <ul class="missing-info-list">
              ${task.missingInfo.map(q => `<li>${q}</li>`).join('')}
            </ul>
          </div>
        `;
      }

      if (task.selfServiceSteps) {
        extras += `
          <div class="self-service-steps">
            <div class="self-service-steps-header">You can handle this:</div>
            <div class="self-service-steps-content">${task.selfServiceSteps}</div>
          </div>
        `;
      }

      return `
        <div class="task-card ${typeClass} ${urgencyClass}">
          <div class="card-header">
            <div class="card-badges">${badges.join('')}</div>
            <span class="card-position">#${task.position}</span>
          </div>
          <div class="card-summary">${task.summary}</div>
          <div class="card-raw">"${truncate(task.rawChunk, 200)}"</div>
          <div class="card-meta">
            ${task.system ? `<span class="card-meta-item"><span class="card-meta-label">System:</span> ${task.system}</span>` : ''}
            <span class="card-meta-item"><span class="card-meta-label">Urgency:</span> ${task.urgency}</span>
          </div>
          ${extras}
        </div>
      `;
    }

    function formatClassification(c) {
      const labels = {
        task: 'Task',
        self_service: 'Self-Service',
        reminder: 'Reminder',
        venting: 'Venting'
      };
      return labels[c] || c;
    }

    function truncate(str, len) {
      if (str.length <= len) return str;
      return str.substring(0, len) + '...';
    }

    // Parse button handler
    document.getElementById('parseBtn').addEventListener('click', async () => {
      const input = document.getElementById('input').value.trim();
      const mockMode = document.getElementById('mockMode').checked;
      const apiUrl = document.getElementById('apiUrl').value;
      const results = document.getElementById('results');
      const jsonContent = document.getElementById('jsonContent');

      if (!input) {
        results.innerHTML = `<div class="error">Please enter some text to parse.</div>`;
        return;
      }

      results.innerHTML = `<div class="loading">Parsing lob</div>`;

      try {
        let data;

        if (mockMode) {
          // Simulate network delay
          await new Promise(r => setTimeout(r, 500));
          data = mockParse(input);
        } else {
          const response = await fetch(`${apiUrl}/api/lob/parse`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input })
          });

          if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
          }

          data = await response.json();
        }

        renderCards(data);
        jsonContent.textContent = JSON.stringify(data, null, 2);

      } catch (error) {
        results.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        jsonContent.textContent = `Error: ${error.message}`;
      }
    });

    // Preset buttons
    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const preset = btn.dataset.preset;
        if (presets[preset]) {
          document.getElementById('input').value = presets[preset];
        }
      });
    });

    // Toggle JSON
    document.getElementById('toggleJson').addEventListener('click', () => {
      const content = document.getElementById('jsonContent');
      const btn = document.getElementById('toggleJson');
      content.classList.toggle('visible');
      btn.textContent = content.classList.contains('visible') ? 'Hide' : 'Show';
    });

    // Parse on Enter (with Ctrl/Cmd)
    document.getElementById('input').addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        document.getElementById('parseBtn').click();
      }
    });
  </script>
</body>
</html>
